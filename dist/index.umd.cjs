(function(s,c){typeof exports=="object"&&typeof module<"u"?c(exports,require("k6/http"),require("k6"),require("https://jslib.k6.io/formdata/0.0.2/index.js"),require("https://jslib.k6.io/url/1.0.0/index.js")):typeof define=="function"&&define.amd?define(["exports","k6/http","k6","https://jslib.k6.io/formdata/0.0.2/index.js","https://jslib.k6.io/url/1.0.0/index.js"],c):(s=typeof globalThis<"u"?globalThis:s||self,c(s["edifice-k6-commons"]={},s.http,s.k6,s.index_js$1,s.index_js))})(this,function(s,c,u,_,T){"use strict";var Fe=Object.defineProperty;var je=(s,c,u)=>c in s?Fe(s,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):s[c]=u;var O=(s,c,u)=>(je(s,typeof c!="symbol"?c+"":c,u),u);const h={COOKIE:0,OAUTH2:1};class ${constructor(e,r,t,n){O(this,"expiresAt");O(this,"token");O(this,"mode");O(this,"cookies");this.token=e,this.mode=r,this.cookies=n,this.expiresAt=Date.now()+t*1e3-3e3}static from(e){const r=new $(e.token,e.mode,0,e.cookies);return r.expiresAt=e.expiresAt,r}isExpired(){return this.expiresAt<=Date.now()}getCookie(e){return this.cookies?this.cookies.filter(r=>r.name===e).map(r=>r.value)[0]:null}}const E=__ENV.BASE_URL,Y=30*60,k=__ENV.ROOT_URL,i=function(o){let e;return o?o.mode===h.COOKIE?e={"x-xsrf-token":o.getCookie("XSRF-TOKEN")||""}:o.mode===h.OAUTH2?e={Authorization:`Bearer ${o.token}`}:e={}:e={},e},Q=function(o,e){const r=c.get(`${k}/conversation/visible?search=${o}`,{headers:i(e)});return u.check(r,{"should get an OK response":n=>n.status==200}),r.json("users")[0].id},Z=function(o){const e=c.get(`${k}/auth/oauth2/userinfo`,{headers:i(o)});return u.check(e,{"should get an OK response":r=>r.status==200,"should get a valid userId":r=>!!r.json("userId")}),e.json("userId")},C=function(o,e){const r=c.cookieJar();r.clear(k);let t={email:o,password:e||__ENV.DEFAULT_PASSWORD||"password",callBack:"",detail:""};const n=c.post(`${k}/auth/login`,t,{redirects:0});if(n.status!==302&&u.fail("should redirect connected user to login page"),(n.cookies.oneSessionId===null||n.cookies.oneSessionId===void 0)&&u.fail("login process should have set an auth cookie"),!n.cookies.oneSessionId)return console.error(`Could not get oneSessionId for ${o}`),null;r.set(k,"oneSessionId",n.cookies.oneSessionId[0].value);const a=Object.keys(n.cookies).map(l=>({name:l,value:n.cookies[l][0].value}));return new $(n.cookies.oneSessionId[0].value,h.COOKIE,Y,a)},x=function(o){const e=c.get(`${k}/auth/logout?callback=/`,{headers:i(o)});return c.cookieJar().clear(k),e},N=function(o){const e=c.cookieJar();return o?(e.set(k,"oneSessionId",o.token),e.set(k,"XSRF-TOKEN",o.getCookie("XSRF-TOKEN")||"")):(e.delete(k,"oneSessionId"),e.delete(k,"XSRF-TOKEN")),o},ee=function(o,e,r,t){let n={grant_type:"password",username:o,password:e,client_id:r,client_secret:t,scope:"timeline userbook blog lvs actualites pronote schoolbook support viescolaire zimbra conversation directory homeworks userinfo workspace portal cas sso presences incidents competences diary edt infra auth"},a=c.post(`${k}/auth/oauth2/token`,n,{redirects:0});u.check(a,{"should get an OK response for authentication":d=>d.status==200,"should have set an access token":d=>!!d.json("access_token")});const l=a.json("access_token");return new $(l,h.OAUTH2,a.json("expires_in"))};function b(o,e){const r=(e||[]).map(t=>t.id);for(let t=0;t<1e3;t++){const n=o[Math.floor(Math.random()*o.length)];if(r.indexOf(n.id)<0)return n}throw"cannot.find.random.user"}function D(o,e,r){const t=o.filter(n=>n.type===e);return b(t,r)}function oe(o,e,r){const t={};t[e]=a=>a.status===r;const n=u.check(o,t);return n||console.error(e,o),n}function re(o,e){let r=c.get(`${k}/directory/user/${o}?manual-groups=true`,{headers:i(e)});return r.status!==200&&(console.error(r),u.fail("Could not get user profile")),JSON.parse(r.body)}function te(o,e){const r=o,t=i(e);return t["content-type"]="application/x-www-form-urlencoded;charset=UTF-8",c.post(`${k}/directory/api/user`,r,{headers:t})}const ne=function(o,e){const r=c.get(`${E}/metrics`,{headers:i(e)});u.check(r,{"should get an OK response":n=>n.status==200});const t=r.body.split(`
`);for(let n of t)if(n.indexOf(`${o} `)===0)return parseFloat(n.substring(o.length+1).trim());return console.error("Metric",o,"not found"),null},y=__ENV.ROOT_URL,I="AdminLocal";function se(o,e,r){let t=A(o,e,r);if(t)console.log("Broadcast group already existed");else{console.log("Creating broadcast group");const n=i(r);n["content-type"]="application/json";let a=JSON.stringify({name:o,structureId:e.id,subType:"BroadcastGroup"}),l=c.post(`${y}/directory/group`,a,{headers:n});u.check(l,{"create broadcast group":p=>p.status===201});const d=JSON.parse(l.body).id;a=JSON.stringify({name:o,autolinkTargetAllStructs:!0,autolinkTargetStructs:[],autolinkUsersFromGroups:["Teacher"]}),l=c.put(`${y}/directory/group/${d}`,a,{headers:n}),u.check(l,{"set broadcast group for teachers":p=>p.status===200});const g=J(e,r).id;P(d,[g],r),t=A(o,e,r)}return t}function P(o,e,r){const t=i(r);t["content-type"]="application/json";for(let n of e){let a=c.post(`${y}/communication/v2/group/${n}/communique/${o}`,"{}",{headers:t});a.status!==200&&(console.error(a),u.fail(`Cannot open comm rule from ${n} to ${o}`))}}function J(o,e){return w("teachers",o,e)}function ce(o,e){return w("students",o,e)}function ae(o,e){return w("relatives",o,e)}function w(o,e,r){return v(e.id,r).filter(n=>{const a=n.name.toLowerCase();return a===`${e.name} group ${o}.`.toLowerCase()||a===`${o} from group ${e.name}.`.toLowerCase()})[0]}function F(o,e){const r=i(e);r["Accept-Language"]="en";let t=c.get(`${y}/directory/group/admin/list?structureId=${o}&translate=false`,{headers:r});return u.check(t,{"get structure profile groups should be ok":n=>n.status==200}),JSON.parse(t.body)}function A(o,e,r){const t=i(r);t["content-type"]="application/json";let n=c.get(`${y}/directory/group/admin/list?translate=false&structureId=${e.id}`,{headers:t});return JSON.parse(n.body).filter(a=>a.subType==="BroadcastGroup"&&a.name===o)[0]}function j(o,e){const r=i(e);r["content-type"]="application/json";let t=c.get(`${y}/directory/user/admin/list?groupId=${o}`,{headers:r});return JSON.parse(t.body)}const f=__ENV.ROOT_URL,ie=new T.URL(f).hostname,G=__ENV.DEFAULT_PASSWORD||"password";function S(o,e){let r=c.get(`${f}/directory/structure/admin/list`,{headers:i(e)});return JSON.parse(r.body).filter(t=>t.name===o)[0]}function L(o,e){let r=c.get(`${f}/directory/structure/${o.id}/users`,{headers:i(e)});if(r.status!==200)throw`Impossible to get users of ${o.id}`;return JSON.parse(r.body)}function M(o,e){let r=c.get(`${f}/directory/structure/${o.id}/users`,{headers:i(e)});r.status!=200&&u.fail(`Cannot fetch users of structure ${o.id} : ${r}`);const t=JSON.parse(r.body);for(let n=0;n<t.length;n++){const a=t[n];B(a)}}function B(o){if(o.code){const e={};e.login=o.login,e.activationCode=o.code,e.password=G,e.confirmPassword=G,e.acceptCGU="true";const r=c.post(`${f}/auth/activation`,e,{redirects:0,headers:{Host:ie}});r.status!==302&&(console.error(r),u.fail(`Could not activate user ${o.login} : ${r.status} - ${r.body}`))}}function le(o,e,r,t){const a=v(o.id,t).filter(l=>r.indexOf(l.name)>=0);for(let l of a)if(l.roles.indexOf(e.name)>=0)console.log("Role already attributed to teachers");else{const d=i(t);d["content-type"]="application/json";const g={headers:d},p=JSON.stringify({groupId:l.id,roleIds:(l.roles||[]).concat([e.id])}),m=c.post(`${f}/appregistry/authorize/group?schoolId=${o.id}`,p,g);u.check(m,{"link role to structure":Je=>Je.status==200})}}function ue(o,e,r){let t=S(o,r);if(t)console.log(`Structure ${o} already exists`);else{const n=i(r);n["content-type"]="application/json";const a=JSON.stringify({hasApp:e,name:o});let l=c.post(`${f}/directory/school`,a,n);l.status!==201&&(console.error(l.body),u.fail(`Could not create structure ${o}`)),t=S(o,r)}return t}function de(o,e,r){const t=i(r);t["content-type"]="application/json";const n=JSON.stringify({hasApp:e,name:o});let a=c.post(`${f}/directory/school`,n,t);return a.status!==201&&(console.error(a.body),u.fail(`Could not create structure ${o}`)),a}function pe(o,e="default"){const r=C(__ENV.ADMC_LOGIN,__ENV.ADMC_PASSWORD),t=V(o,e);return M(t,r),t}function V(o,e="default"){const r=o||"General",t=C(__ENV.ADMC_LOGIN,__ENV.ADMC_PASSWORD),n="https://raw.githubusercontent.com/edificeio/edifice-k6-commons/develop/data/structure",a=c.get(`${n}/enseignants.${e}.csv`).body,l=c.get(`${n}/eleves.${e}.csv`).body,d=c.get(`${n}/responsables.${e}.csv`).body;return K(r,{teachers:a,students:l,responsables:d},t)}function K(o,e,r){let t=S(o,r);if(t)console.log("School already exists");else{const n=new _.FormData;n.append("type","CSV"),n.append("structureName",o);let a,l,d;"teachers"in e?(a=e.teachers,l=e.students,d=e.responsables):a=e,n.append("Teacher",c.file(a,"enseignants.csv")),l&&n.append("Student",c.file(l,"eleves.csv")),d&&n.append("Relative",c.file(d,"responsables.csv"));const g=i(r);g["Content-Type"]="multipart/form-data; boundary="+n.boundary;const p={headers:g};c.post(`${f}/directory/wizard/import`,n.body(),p).status!=200&&u.fail(`Could not create structure ${o}`),t=S(o,r)}return t}function fe(o,e,r){let t;if((e.parents||[]).map(a=>a.id).indexOf(o.id)>=0)console.log(`${e.name} is already a child of ${o.name}`),t=!1;else{const a=i(r);a["content-type"]="application/json",c.put(`${f}/directory/structure/${e.id}/parent/${o.id}`,"{}").status!==200&&u.fail(`Could not attach structure ${e.name} as a child of ${o.name}`),t=!0}return t}function ge(o,e,r){const t=new _.FormData;t.append("type","CSV"),t.append("structureName",o.name),t.append("structureId",o.id),t.append("structureExternalId",o.externalId);let n,a,l;"teachers"in e?(n=e.teachers,a=e.students,l=e.responsables):n=e,t.append("Teacher",c.file(n,"enseignants.csv")),a&&t.append("Student",c.file(a,"eleves.csv")),l&&t.append("Relative",c.file(l,"responsables.csv"));const d=i(r);d["Content-Type"]="multipart/form-data; boundary="+t.boundary;const g={headers:d};return c.post(`${f}/directory/wizard/import`,t.body(),g)}function ke(o){const e=i(o);return e["content-type"]="application/json",c.post(`${f}/directory/import`,"{}",{headers:e})}function W(o,e,r){const t=i(r);t["content-type"]="application/json";const n=JSON.stringify({name:o,structureId:e.id});return c.post(`${f}/directory/positions`,n,{redirects:0,headers:t})}function me(o,e){const r=i(e);r["content-type"]="application/json";const t=JSON.stringify(o);return c.put(`${f}/directory/positions/${o.id}`,t,{redirects:0,headers:r})}function ye(o,e,r){let t=W(o,e,r);if(t.status===409){const n=JSON.parse(t.body).existingPositionId;return H(n,r)}else return JSON.parse(t.body)}function he(o,e,r){const t=i(r);t["content-type"]="application/json";const n={};return e!=null&&(n.positionIds=e.map(l=>l.id)),c.put(`${f}/directory/user/${o.id}`,JSON.stringify(n),{headers:t})}function $e(o,e){const r=i(e);return r["content-type"]="application/json",c.del(`${f}/directory/positions/${o}`,null,{redirects:0,headers:r})}function H(o,e){let r=c.get(`${f}/directory/positions/${o}`,{headers:i(e)});return JSON.parse(r.body)}function Se(o,e,r){const t=W(o,e,r);return t.status!==201&&(console.error(t),u.fail(`Could not create position ${o} on structure ${e.name}`)),JSON.parse(t.body)}function Oe(o,e){const r=i(e),t=new T.URL(`${f}/directory/positions`);return t.searchParams.append("content",o),c.get(t.toString(),{headers:r})}function q(o,e,r){const t=i(r);t["content-type"]="application/json";const n=JSON.stringify({functionCode:"ADMIN_LOCAL",inherit:"s",scope:[e.id]});let a=c.post(`${f}/directory/user/function/${o.id}`,n,{headers:t});return z(a,"user should be made ADML"),a}function Ce(o,e,r,t,n){const l=F(o.id,n).filter(g=>g.filter===I)[0];let d;if(l){const g=j(l.id,n);d=e?g.filter(p=>p.type===e):g}else d=[];if(t&&t.length>0){const g=t.map(p=>p.id);d=d.filter(p=>g.indexOf(p.id)<0)}if(d.length<r){const g=L(o,n);for(let p=d.length;p<r;p++){let m;e?m=D(g,e,d):m=b(g,d),console.log(`Turning ${m.login} into an ADML of ${o.id} - ${o.name}`),q(m,o,n),d.push(m)}}return d.slice(0,r)}function we(o,e,r){try{const t=C(__ENV.ADMC_LOGIN,__ENV.ADMC_PASSWORD),n=Array.isArray(e)?e:[e];for(let a of n)c.put(`${f}/directory/structure/${a.id}/link/${o.id}`,null,{headers:i(t)})}finally{N(r)}}const R=__ENV.ROOT_URL;function U(o,e){let r=c.get(`${R}/appregistry/roles`,{headers:i(e)});return JSON.parse(r.body).filter(n=>n.name===o)[0]}function Re(o,e){const r=`${o} - All - Stress Test`;let t=U(r,e);if(t)console.log(`Role ${r} already existed`);else{let n=c.get(`${R}/appregistry/applications/actions?actionType=WORKFLOW`,{headers:i(e)});u.check(n,{"get workflow actions":p=>p.status==200});const l=JSON.parse(n.body).filter(p=>p.name===o)[0].actions.map(p=>p[0]),d=i(e);d["content-type"]="application/json";const g={role:r,actions:l};n=c.post(`${R}/appregistry/role`,JSON.stringify(g),{headers:d}),console.log(n),u.check(n,{"save role ok":p=>p.status==201}),t=U(r,e)}return t}function v(o,e){const r=i(e);r["Accept-Language"]="en";let t=c.get(`${R}/appregistry/groups/roles?structureId=${o}&translate=false`,{headers:r});return u.check(t,{"get structure roles should be ok":n=>n.status==200}),JSON.parse(t.body)}const _e=__ENV.ROOT_URL,be=["org-entcore-workspace-controllers-WorkspaceController|getDocument","org-entcore-workspace-controllers-WorkspaceController|copyDocuments","org-entcore-workspace-controllers-WorkspaceController|getDocumentProperties","org-entcore-workspace-controllers-WorkspaceController|getRevision","org-entcore-workspace-controllers-WorkspaceController|copyFolder","org-entcore-workspace-controllers-WorkspaceController|getPreview","org-entcore-workspace-controllers-WorkspaceController|copyDocument","org-entcore-workspace-controllers-WorkspaceController|getDocumentBase64","org-entcore-workspace-controllers-WorkspaceController|listRevisions","org-entcore-workspace-controllers-WorkspaceController|commentFolder","org-entcore-workspace-controllers-WorkspaceController|commentDocument","org-entcore-workspace-controllers-WorkspaceController|shareJson","org-entcore-workspace-controllers-WorkspaceController|deleteFolder","org-entcore-workspace-controllers-WorkspaceController|restoreFolder","org-entcore-workspace-controllers-WorkspaceController|removeShare","org-entcore-workspace-controllers-WorkspaceController|moveFolder","org-entcore-workspace-controllers-WorkspaceController|moveTrash","org-entcore-workspace-controllers-WorkspaceController|restoreTrash","org-entcore-workspace-controllers-WorkspaceController|bulkDelete","org-entcore-workspace-controllers-WorkspaceController|shareResource","org-entcore-workspace-controllers-WorkspaceController|deleteRevision","org-entcore-workspace-controllers-WorkspaceController|shareJsonSubmit","org-entcore-workspace-controllers-WorkspaceController|moveDocument","org-entcore-workspace-controllers-WorkspaceController|renameFolder","org-entcore-workspace-controllers-WorkspaceController|moveTrashFolder","org-entcore-workspace-controllers-WorkspaceController|deleteComment","org-entcore-workspace-controllers-WorkspaceController|getParentInfos","org-entcore-workspace-controllers-WorkspaceController|deleteDocument","org-entcore-workspace-controllers-WorkspaceController|renameDocument","org-entcore-workspace-controllers-WorkspaceController|moveDocuments","org-entcore-workspace-controllers-WorkspaceController|updateDocument"],Ae=["org-entcore-workspace-controllers-WorkspaceController|getDocument","org-entcore-workspace-controllers-WorkspaceController|copyDocuments","org-entcore-workspace-controllers-WorkspaceController|getDocumentProperties","org-entcore-workspace-controllers-WorkspaceController|getRevision","org-entcore-workspace-controllers-WorkspaceController|copyFolder","org-entcore-workspace-controllers-WorkspaceController|getPreview","org-entcore-workspace-controllers-WorkspaceController|copyDocument","org-entcore-workspace-controllers-WorkspaceController|getDocumentBase64","org-entcore-workspace-controllers-WorkspaceController|listRevisions","org-entcore-workspace-controllers-WorkspaceController|commentFolder","org-entcore-workspace-controllers-WorkspaceController|commentDocument"];function We(o,e){let r=i(e);const t=new _.FormData;t.append("file",c.file(o,"file.txt")),r["Content-Type"]="multipart/form-data; boundary="+t.boundary;let n=c.post(`${_e}/workspace/document`,t.body(),{headers:r});return u.check(n,{"upload doc ok":a=>a.status===201}),JSON.parse(n.body)}const Ue=__ENV.ROOT_URL;function ve(o,e,r){const t=i(r);t["content-type"]="application/json";const n=JSON.stringify(e);return c.put(`${Ue}/workspace/share/resource/${o}`,n,{headers:t})}const Te=__ENV.ROOT_URL;function Ee(o,e,r){const t=c.post(`${Te}/communication/v2/group/${o}/communique/${e}`,"{}",{headers:i(r)});return t.status!==200&&(console.error(`Error while adding communication between ${o} -> ${e}`),console.error(t),u.fail(`could not add communication between ${o} -> ${e}`)),t}function z(o,e,r=200){const t=r||200;o.status!=t&&(console.error(`ko - ${e}. Expecting ${t} but got ${o.status}`),console.error(o),u.fail(e+" ko"))}function Ne(o,e,r=500){X(()=>o&&o.code===r,`[${o.request.method}]${o.url} returns code ${r}: ${e} `)}function De(o,e,r=500){const t={};return t[`${e} (expects ${r})`]=()=>{const n=o&&o.status===r;return n||(console.warn("Expected ",r," but got ",o.status),console.warn(o)),n},u.check({},t)}function X(o,e){const r={};r[e]=()=>o,u.check({},r)||u.fail(e)}const Ie=__ENV.ROOT_URL;function Pe(o){let e=c.get(`${Ie}/userbook/search/criteria`,{headers:i(o)});return JSON.parse(e.body)}s.ADML_FILTER=I,s.BASE_URL=E,s.Session=$,s.SessionMode=h,s.WS_MANAGER_SHARE=be,s.WS_READER_SHARE=Ae,s.activateUser=B,s.activateUsers=M,s.addCommRuleToGroup=P,s.addCommunicationBetweenGroups=Ee,s.assertCondition=X,s.assertKo=Ne,s.assertOk=z,s.attachStructureAsChild=fe,s.attachUserToStructures=we,s.attributePositions=he,s.authenticateOAuth2=ee,s.authenticateWeb=C,s.checkReturnCode=De,s.checkStatus=oe,s.createAndSetRole=Re,s.createBroadcastGroup=se,s.createDefaultStructure=V,s.createEmptyStructure=ue,s.createEmptyStructureNoCheck=de,s.createPosition=W,s.createPositionOrFail=Se,s.createStructure=K,s.createUser=te,s.deletePosition=$e,s.getAdmlsOrMakThem=Ce,s.getBroadcastGroup=A,s.getConnectedUserId=Z,s.getHeaders=i,s.getMetricValue=ne,s.getOrCreatePosition=ye,s.getParentRole=ae,s.getPositionByIdOrFail=H,s.getProfileGroupOfStructure=w,s.getProfileGroupsOfStructure=F,s.getRandomUser=b,s.getRandomUserWithProfile=D,s.getRoleByName=U,s.getRolesOfStructure=v,s.getSchoolByName=S,s.getSearchCriteria=Pe,s.getStudentRole=ce,s.getTeacherRole=J,s.getUserProfileOrFail=re,s.getUsersOfGroup=j,s.getUsersOfSchool=L,s.importUsers=ge,s.initStructure=pe,s.linkRoleToUsers=le,s.logout=x,s.makeAdml=q,s.searchPositions=Oe,s.searchUser=Q,s.shareFile=ve,s.switchSession=N,s.triggerImport=ke,s.updatePosition=me,s.uploadFile=We,Object.defineProperty(s,Symbol.toStringTag,{value:"Module"})});
